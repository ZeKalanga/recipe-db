name: Deploy Recipe API

on:
  push:
    branches:
      - main

jobs:
  update-server:
    runs-on: ubuntu-latest

    steps:
      - name: SSH into Server and Update API
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 18.199.163.68 >> ~/.ssh/known_hosts

          ssh -o StrictHostKeyChecking=no ubuntu@18.199.163.68 << 'EOF'
            set -e
            cd /var/www/recipe-api

            echo "ðŸš€ Pulling latest changes from main branch"
            git fetch --all
            git reset --hard origin/main

            echo "ðŸ”„ Updating submodules (recipe-db)"
            git submodule update --init --recursive
            git submodule foreach git pull origin main

            echo "ðŸ“¦ Installing dependencies"
            npm install --production

            echo "ðŸ”¨ Building project"
            npm run build

            echo "ðŸš€ Restarting API process via pm2"
            pm2 restart recipe-api || pm2 start npm --name "recipe-api" -- run start
            pm2 save

            echo "âœ… API deployment completed successfully."
          EOF
