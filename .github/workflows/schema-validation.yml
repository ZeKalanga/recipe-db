name: Recipe Schema Validation

on:
  pull_request:
    paths:
      - "recipes/**/*.yaml"

jobs:
  validate-schema:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install jsonschema pyyaml

      - name: Debug Schema & Rezepte
        run: |
          echo "ğŸ” Debugging Schema Validation..."
          echo "ğŸ“‚ Zeige Schema-Datei:"
          cat schema/recipe-schema-v1.yaml
          echo "ğŸ“‚ Zeige Naan-Rezept:"
          cat recipes/brote_backwaren/pizza_fladenbrote/naan/naan.yaml

      - name: Validate recipes
        run: |
          python -c "
          import yaml, jsonschema, os;
          print('ğŸ” Lade Schema...')
          schema = yaml.safe_load(open('schema/recipe-schema-v1.yaml'))
          print('âœ… Schema erfolgreich geladen!')

          for root, dirs, files in os.walk('recipes'):
            for file in files:
              if file.endswith('.yaml'):
                filepath = os.path.join(root, file)
                print(f'ğŸ“‚ PrÃ¼fe Rezept: {filepath}')
                with open(filepath, 'r') as f:
                    recipe = yaml.safe_load(f)
                
                try:
                    jsonschema.validate(instance=recipe, schema=schema)
                    print(f'âœ… {file} ist gÃ¼ltig!')
                except jsonschema.exceptions.ValidationError as e:
                    print(f'âŒ FEHLER in {file}: {e.message}')
                    exit(1)

          print('âœ… Alle Rezepte sind gÃ¼ltig!')"
