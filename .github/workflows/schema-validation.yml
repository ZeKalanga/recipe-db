name: Schema Validation
on:
  pull_request:  # üö® Blockiert PRs bei Fehlern!
    paths:
      - "recipes/**/*.yaml"
  push:  # ‚úÖ Pr√ºft Commits in `main`, aber stoppt sie nicht
    branches:
      - main

jobs:
  validate-schema:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install jsonschema pyyaml

      - name: Validate recipes
        run: |
          python -c "
          import yaml, jsonschema, os;
          print('üîç Lade Schema...')
          schema = yaml.safe_load(open('schema/recipe-schema-v1.yaml'))
          print('‚úÖ Schema erfolgreich geladen!')

          for root, dirs, files in os.walk('recipes'):
            for file in files:
              if file.endswith('.yaml'):
                filepath = os.path.join(root, file)
                print(f'üìÇ Pr√ºfe Rezept: {filepath}')
                with open(filepath, 'r') as f:
                    recipe = yaml.safe_load(f)

                try:
                    jsonschema.validate(instance=recipe['recipe'], schema=schema['recipe'])
                    print(f'‚úÖ {file} ist g√ºltig!')
                except jsonschema.exceptions.ValidationError as e:
                    print(f'‚ùå FEHLER in {file}: {e.message}')
                    if os.getenv('GITHUB_EVENT_NAME') == 'pull_request':
                        exit(1)  # üö® PR blockieren
                    else:
                        print('‚ö†Ô∏è WARNUNG: Fehler erkannt, aber Commit in main wird nicht blockiert.')

          print('‚úÖ Alle Rezepte sind g√ºltig!')"
        continue-on-error: ${{ github.event_name == 'push' }}  # ‚ö†Ô∏è Fehler ignorieren bei direktem Commit in `main`
